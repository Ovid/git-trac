#!/usr/bin/env perl

use 5.010;
use strict;
use warnings;
use lib 'lib';
use Pod::Usage;
use Getopt::Long;

our $VERSION = '0.01';

GetOptions(
    'help|?'  => sub { pod2usage( -verbose => 1 ) },
    'man'     => sub { pod2usage( -verbose => 2 ) },
    'refresh' => \my $refresh,
    'version' => \my $version,
) or die "Bad Options";

my ( $command, @args ) = @ARGV;

if ( $version ) {
    say "git-trac version $Git::Trac::VERSION";
    exit 0;
}

if ($refresh) {
    $command //= 'list';
}

use Git::Trac;
my $trac = Git::Trac->new( refresh => $refresh );

if ($command) {
    given ($command) {
        when ('tickets') { say $trac->tickets_to_string }
        when ('tasks')   { say $trac->tasks_to_string }
        when ('start')   { $trac->start_task(@args) }
        when ('switch')  { say $trac->switch_task(@args) }
        when ('commit')  { die 'unimplemented' }
        when ('delete')  { $trac->delete(@args) }
        default          { say "Unknown command: $command" }
    }
}
else {
    say "No command given";
    pod2usage( -verbose => 1 );
    exit 1;
}

__END__

=head1 NAME

git-trac - Manage your trac tickets with git.

=head1 VERSION

0.01

=head1 SYNOPSIS

    git trac [--help|-?]
    git trac [--man]
    git trac [--refresh] COMMAND ARGS

Options:

    --help,-h,-?     Brief help message
    --man,-m         Long help message
    --refresh,-r     Force a refresh of Trac tickets
    --version,-v     Print version of Git::Trac

Commands:

    tickets                      List open tickets
    tasks                        List tasks
    start  $number $branch_name  Start working on ticket $number in branch $branch_name
    switch $number               Switch to already started task $number
    commit $message              Commit a change with $message, posting the message to Trac
    delete $number               Will delete the task (but not the branch)

=head1 DESCRIPTION

Eventually we'll have something here
